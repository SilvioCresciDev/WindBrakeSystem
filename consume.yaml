metadata:
  name: consume
  labels:
    nuclio.io/project-name: 7e2b7348-baaa-4373-a9ce-c04943d8fab6
spec:
  description: "Function the is called when a new message is arrived on the iot/sensors/temperature queue, //the function send back a feedback on the iot/logs queue."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-consume:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@192.168.137.1:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/sensors/speed
  version: 1
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CiAgICB2YXIgRlVOQ1RJT05fTkFNRSA9ICJjb25zdW1lIjsKCiAgICB2YXIgbXF0dCA9IHJlcXVpcmUoJ21xdHQnKSwgdXJsID0gcmVxdWlyZSgndXJsJyk7CgogICAgdmFyIG1xdHRfdXJsID0gdXJsLnBhcnNlKHByb2Nlc3MuZW52LkNMT1VEQU1RUF9NUVRUX1VSTCB8fCAnbXF0dDovL2d1ZXN0Omd1ZXN0QDE5Mi4xNjguMTM3LjE6MTg4MycpOwogICAgdmFyIGF1dGggPSAobXF0dF91cmwuYXV0aCB8fCAnOicpLnNwbGl0KCc6Jyk7CiAgICB2YXIgdXJsID0gIm1xdHQ6Ly8iICsgbXF0dF91cmwuaG9zdDsKCiAgICB2YXIgb3B0aW9ucyA9IHsKICAgIHBvcnQ6IG1xdHRfdXJsLnBvcnQsCiAgICBjbGllbnRJZDogJ21xdHRqc18nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyKDIsIDgpLAogICAgdXNlcm5hbWU6IGF1dGhbMF0sCiAgICBwYXNzd29yZDogYXV0aFsxXSwKICAgIH07CgoKICAgIGZ1bmN0aW9uIHNlbmRfZmVlZGJhY2sobXNnKXsKICAgICAgICB2YXIgcSA9ICdpb3QvbG9ncyc7CiAgICAgICAgYW1xcC5jb25uZWN0KCdhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAMTkyLjE2OC4xMzcuMTo1NjcyJykudGhlbihmdW5jdGlvbihjb25uKSB7CiAgICAgICAgICAgIHJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgICAgICAgICB2YXIgb2sgPSBjaC5hc3NlcnRRdWV1ZShxLCB7ZHVyYWJsZTogZmFsc2V9KTsKICAgICAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsKICAgICAgICAgICAgICAgIGNoLnNlbmRUb1F1ZXVlKHEsIEJ1ZmZlci5mcm9tKG1zZykpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIiBbeF0gU2VudCAnJXMnIiwgbXNnKTsKICAgICAgICAgICAgICAgIHJldHVybiBjaC5jbG9zZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbm4uY2xvc2UoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7CiAgICB9CgogICAgZnVuY3Rpb24gYmluMnN0cmluZyhhcnJheSl7CiAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSl7CiAgICAgICAgcmVzdWx0Kz0gKFN0cmluZy5mcm9tQ2hhckNvZGUoYXJyYXlbaV0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBzZW5kVG9CcmFrZSh2YWwpewogICAgICAgIHZhciBjbGllbnQgPSBtcXR0LmNvbm5lY3QodXJsLCBvcHRpb25zKTsKICAgICAgICBjbGllbnQub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIiBVUkwgPSAlcyIsIHVybCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgVkFMID0gJXMiLCB2YWwpOwogICAgICAgICAgICBjbGllbnQucHVibGlzaCgnaW90L2FjdHVhdG9yL2JyYWtlJywgdmFsLnRvU3RyaW5nKCksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY2xpZW50LmVuZCgpOyAKICAgICAgICAgICAgfSApOyAgICAgICAgICAgICAgICAKICAgICAgICB9KTsgIAogICAgfQoKICAgIGZ1bmN0aW9uIHNlbmROb3RpZmljYXRpb24odmFsKXsKICAgICAgICB2YXIgY2xpZW50ID0gbXF0dC5jb25uZWN0KHVybCwgb3B0aW9ucyk7CiAgICAgICAgY2xpZW50Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgVVJMID0gJXMiLCB1cmwpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiIFZBTCA9ICVzIiwgdmFsKTsKICAgICAgICAgICAgY2xpZW50LnB1Ymxpc2goJ2lvdC9ub3RpZmljYXRpb24vbWFpbnRlbmFuY2UnLCB2YWwudG9TdHJpbmcoKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjbGllbnQuZW5kKCk7IAogICAgICAgICAgICB9ICk7ICAgICAgICAgICAgICAgIAogICAgICAgIH0pOyAgCiAgICB9CgogICAgZXhwb3J0cy5oYW5kbGVyID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgICAgICB2YXIgX2V2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOwogICAgICAgIHZhciBfZGF0YSA9IGJpbjJzdHJpbmcoX2V2ZW50LmJvZHkuZGF0YSk7CgogICAgICAgIHZhciBwZXJjZW50YWdlID0gX2RhdGEuc3Vic3RyaW5nKDAsMik7CiAgICAgICAgdmFyIHNwZWVkID0gX2RhdGEuc3Vic3RyaW5nKDMpOwoKICAgICAgICBjb25zb2xlLmxvZygiIHBlcmNlbnRhZ2UgPSAlcyIsIHBlcmNlbnRhZ2UpOwogICAgICAgIGNvbnNvbGUubG9nKCIgc3BlZWQgPSAlcyIsIHNwZWVkKTsKCiAgICAgICAgaWYgKHNwZWVkID49IDc1KSB7CiAgICAgICAgICAgIHNlbmRUb0JyYWtlKCJTcGVlZCA9ICIrc3BlZWQrImttL2ggQWN0aXZhdGUgQnJha2UhIikKICAgICAgICB9CiAgICAgICAgZWxzZXsKICAgICAgICAgICAgc2VuZFRvQnJha2UoIlNwZWVkID0gIitzcGVlZCsia20vaCBEZWFjdGl2YXRlIEJyYWtlISIpCiAgICAgICAgfQoKICAgICAgICBpZihwZXJjZW50YWdlIDw9IDE1KXsKICAgICAgICAgICAgc2VuZE5vdGlmaWNhdGlvbigiQnJha2UgbWFpbnRlbmFuY2UgcmVxdWlyZWQhIik7CiAgICAgICAgfQogICAgICAgIGVsc2V7CiAgICAgICAgICAgIHNlbmROb3RpZmljYXRpb24oIkJyYWtlcyBsZXZlbCA9ICIrcGVyY2VudGFnZSsiJSIpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjb250ZXh0LmNhbGxiYWNrKCJmZWVkYmFjayAiK19kYXRhKTsKCiAgICAgICAgY29uc29sZS5sb2coIlRSSUdHRVIgIitfZGF0YSk7CiAgICAgICAgc2VuZF9mZWVkYmFjaygiSW52b2tlZCBGdW5jdGlvbiBNUVRUOiAiK0ZVTkNUSU9OX05BTUUrIiByZWNlaXZlZCAiK19kYXRhKTsKICAgIH07
    commands:
      - 'npm install amqplib'
      - 'npm install url'
      - 'npm install mqtt'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
