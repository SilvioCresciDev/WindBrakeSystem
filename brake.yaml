metadata:
  name: brake
  labels:
    nuclio.io/project-name: 7e2b7348-baaa-4373-a9ce-c04943d8fab6
spec:
  description: "Function the is called when a new message is arrived on the iot/sensors/temperature queue, //the function send back a feedback on the iot/logs queue."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-brake:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@192.168.137.1:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/sensors/speed
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CiAgICB2YXIgRlVOQ1RJT05fTkFNRSA9ICJicmFrZSI7CgogICAgdmFyIG1xdHQgPSByZXF1aXJlKCdtcXR0JyksIHVybCA9IHJlcXVpcmUoJ3VybCcpOwoKICAgIHZhciBtcXR0X3VybCA9IHVybC5wYXJzZShwcm9jZXNzLmVudi5DTE9VREFNUVBfTVFUVF9VUkwgfHwgJ21xdHQ6Ly9ndWVzdDpndWVzdEAxOTIuMTY4LjEzNy4xOjE4ODMnKTsKICAgIHZhciBhdXRoID0gKG1xdHRfdXJsLmF1dGggfHwgJzonKS5zcGxpdCgnOicpOwogICAgdmFyIHVybCA9ICJtcXR0Oi8vIiArIG1xdHRfdXJsLmhvc3Q7CgogICAgdmFyIG9wdGlvbnMgPSB7CiAgICBwb3J0OiBtcXR0X3VybC5wb3J0LAogICAgY2xpZW50SWQ6ICdtcXR0anNfJyArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cigyLCA4KSwKICAgIHVzZXJuYW1lOiBhdXRoWzBdLAogICAgcGFzc3dvcmQ6IGF1dGhbMV0sCiAgICB9OwoKCiAgICBmdW5jdGlvbiBzZW5kX2ZlZWRiYWNrKG1zZyl7CiAgICAgICAgdmFyIHEgPSAnaW90L2xvZ3MnOwogICAgICAgIGFtcXAuY29ubmVjdCgnYW1xcDovL2d1ZXN0Omd1ZXN0QDE5Mi4xNjguMTM3LjE6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewogICAgICAgICAgICByZXR1cm4gY29ubi5jcmVhdGVDaGFubmVsKCkudGhlbihmdW5jdGlvbihjaCkgewogICAgICAgICAgICAgICAgdmFyIG9rID0gY2guYXNzZXJ0UXVldWUocSwge2R1cmFibGU6IGZhbHNlfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gb2sudGhlbihmdW5jdGlvbihfcW9rKSB7CiAgICAgICAgICAgICAgICBjaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgW3hdIFNlbnQgJyVzJyIsIG1zZyk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2guY2xvc2UoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KS5maW5hbGx5KGZ1bmN0aW9uKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25uLmNsb3NlKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChjb25zb2xlLndhcm4pOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbjJzdHJpbmcoYXJyYXkpewogICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpewogICAgICAgIHJlc3VsdCs9IChTdHJpbmcuZnJvbUNoYXJDb2RlKGFycmF5W2ldKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gc2VuZFRvQnJha2UodmFsKXsKICAgICAgICB2YXIgY2xpZW50ID0gbXF0dC5jb25uZWN0KHVybCwgb3B0aW9ucyk7CiAgICAgICAgY2xpZW50Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgVVJMID0gJXMiLCB1cmwpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiIFZBTCA9ICVzIiwgdmFsKTsKICAgICAgICAgICAgY2xpZW50LnB1Ymxpc2goJ2lvdC9hY3R1YXRvci9icmFrZScsIHZhbC50b1N0cmluZygpLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNsaWVudC5lbmQoKTsgCiAgICAgICAgICAgIH0gKTsgICAgICAgICAgICAgICAgCiAgICAgICAgfSk7ICAKICAgIH0KCiAgICBmdW5jdGlvbiBzZW5kTm90aWZpY2F0aW9uKHZhbCl7CiAgICAgICAgdmFyIGNsaWVudCA9IG1xdHQuY29ubmVjdCh1cmwsIG9wdGlvbnMpOwogICAgICAgIGNsaWVudC5vbignY29ubmVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiIFVSTCA9ICVzIiwgdXJsKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIiBWQUwgPSAlcyIsIHZhbCk7CiAgICAgICAgICAgIGNsaWVudC5wdWJsaXNoKCdpb3Qvbm90aWZpY2F0aW9uL21haW50ZW5hbmNlJywgdmFsLnRvU3RyaW5nKCksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY2xpZW50LmVuZCgpOyAKICAgICAgICAgICAgfSApOyAgICAgICAgICAgICAgICAKICAgICAgICB9KTsgIAogICAgfQoKICAgIGV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7CiAgICAgICAgdmFyIF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsKICAgICAgICB2YXIgX2RhdGEgPSBiaW4yc3RyaW5nKF9ldmVudC5ib2R5LmRhdGEpOwoKICAgICAgICB2YXIgcGVyY2VudGFnZSA9IF9kYXRhLnN1YnN0cmluZygwLDIpOwogICAgICAgIHZhciBzcGVlZCA9IF9kYXRhLnN1YnN0cmluZygzKTsKCiAgICAgICAgY29uc29sZS5sb2coIiBwZXJjZW50dWFsZSA9ICVzIiwgcGVyY2VudGFnZSk7CiAgICAgICAgY29uc29sZS5sb2coIiBTUEVFRCA9ICVzIiwgc3BlZWQpOwoKICAgICAgICBpZiAoc3BlZWQgPj0gNzUpIHsKICAgICAgICAgICAgc2VuZFRvQnJha2UoIkFjdGl2ZSBCcmFrZSEiKQogICAgICAgIH0KICAgICAgICBlbHNlewogICAgICAgICAgICBzZW5kVG9CcmFrZSgiRGVhY3RpdmUgQnJha2UiKQogICAgICAgIH0KCiAgICAgICAgaWYocGVyY2VudGFnZSA8PSAxNSl7CiAgICAgICAgICAgIHNlbmROb3RpZmljYXRpb24oIkJyYWtlIG1haW50ZW5hbmNlIHJlcXVpcmVkISIpOwogICAgICAgIH0KICAgICAgICBlbHNlewogICAgICAgICAgICBzZW5kTm90aWZpY2F0aW9uKCJCcmFrZXMgbGV2ZWwgPSAiKyBwZXJjZW50YWdlKyIlIik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrICIrX2RhdGEpOwoKICAgICAgICBjb25zb2xlLmxvZygiVFJJR0dFUiAiK19kYXRhKTsKICAgICAgICBzZW5kX2ZlZWRiYWNrKCJJbnZva2VkIEZ1bmN0aW9uIE1RVFQ6ICIrRlVOQ1RJT05fTkFNRSsiIHJlY2VpdmVkICIrX2RhdGEpOwogICAgfTs=
    commands:
      - 'npm install amqplib'
      - 'npm install url'
      - 'npm install mqtt'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  version: 1
